---
id: "004"
title: "Unit Placement & Swap System"
status: "todo"
priority: "high"
estimate: "8h"
tags: ["units", "placement", "ui", "interaction"]
dependencies: ["002", "003"]
parallel: true
conflicts: ["003"]
created: "2025-10-28T02:12:15Z"
updated: "2025-10-28T02:12:15Z"
---

# Task 004: Unit Placement & Swap System

## Overview
Implement interactive unit placement and swapping mechanics on the grid system. Enable click-to-select units from inventory and click-to-place/swap on grid cells with visual feedback.

## Objectives
- Implement click-to-select unit from inventory
- Enable click-to-place units on grid cells
- Add unit swap functionality between cells
- Provide visual feedback for selection and placement
- Validate placement rules (one unit per cell)

## Technical Specifications

### Namespace
`LottoDefense.Units`

### Files to Modify/Create
- `Assets/Scripts/Units/UnitManager.cs` - Add placement logic
- `Assets/Scripts/Units/Unit.cs` - Add selection state
- `Assets/Scripts/Grid/GridManager.cs` - Handle placement validation
- `Assets/Scripts/UI/UnitSelectionUI.cs` - Inventory selection interface

### Placement Flow
1. **Selection Phase:**
   - Player clicks unit in inventory UI
   - Selected unit highlighted
   - Grid cells show placement indicators
   - Cursor changes to placement mode

2. **Placement Phase:**
   - Player clicks valid grid cell
   - If empty: Place unit
   - If occupied: Swap with existing unit
   - Exit placement mode

3. **Visual Feedback:**
   - Selected unit: Outline/glow effect
   - Valid cells: Green highlight
   - Invalid cells: Red highlight
   - Occupied cells: Yellow highlight (swappable)

### UnitManager Extensions
```csharp
// New properties
- UnitData selectedUnit
- bool isPlacementMode

// New methods
- SelectUnit(UnitData unit)
- PlaceUnit(Vector2Int gridPosition)
- SwapUnits(Vector2Int pos1, Vector2Int pos2)
- CancelPlacement()
- IsValidPlacement(Vector2Int position) → bool
```

### GridManager Integration
```csharp
// New methods in GridManager
- GetUnitAt(Vector2Int position) → Unit
- SetUnit(Vector2Int position, Unit unit)
- RemoveUnit(Vector2Int position)
- IsPlacementCell(Vector2Int position) → bool
- GetCellWorldPosition(Vector2Int position) → Vector3
```

### Visual Feedback System
1. **Selection Indicator:**
   - Sprite outline shader
   - Glow effect on selected unit card
   - Color: Yellow/Gold

2. **Grid Cell Highlights:**
   - Overlay sprite per cell state
   - Empty valid: Green tint (α=0.3)
   - Occupied swappable: Yellow tint (α=0.3)
   - Invalid: Red tint (α=0.3)

3. **Cursor Changes:**
   - Normal: Default cursor
   - Placement mode: Custom placement cursor
   - Over valid cell: Checkmark cursor
   - Over invalid cell: X cursor

### Input Handling
```csharp
// Input flow
1. OnInventoryUnitClick(UnitData)
   - Set selectedUnit
   - Enable placement mode
   - Show grid highlights

2. OnGridCellClick(Vector2Int)
   - Validate placement
   - Execute place or swap
   - Update inventory
   - Exit placement mode

3. OnCancelInput() // ESC or right-click
   - Clear selection
   - Disable placement mode
   - Hide highlights
```

## Implementation Steps
1. Extend UnitManager with placement state management
2. Add selection highlighting to unit inventory UI
3. Implement grid cell click detection
4. Create placement validation logic
5. Build swap functionality
6. Add visual feedback system (highlights, cursors)
7. Implement cancel/escape functionality
8. Test placement and swap edge cases

## Testing Requirements
- Verify unit selection from inventory
- Test placement on empty cells
- Test swap between occupied cells
- Validate placement restrictions (non-path cells only)
- Test cancel functionality (ESC key)
- Verify visual feedback appears correctly
- Test multiple rapid placements
- Edge case: Swap with same unit type

## Dependencies
- **Depends on:** Task 002 (Grid system), Task 003 (Unit inventory)
- **Parallel work:** Can work alongside Task 003
- **Conflict warning:** Both 003 and 004 modify UnitManager - coordinate changes carefully

## Acceptance Criteria
- [ ] Click unit in inventory to select
- [ ] Click grid cell to place selected unit
- [ ] Swap units by clicking occupied cell
- [ ] Visual highlights show valid/invalid cells
- [ ] Selected unit indicator visible
- [ ] Placement validates grid rules
- [ ] Cancel selection with ESC or right-click
- [ ] One unit per cell enforced
- [ ] Smooth visual feedback transitions
- [ ] No placement on path cells

## Notes
- Consider adding drag-and-drop alternative
- Future: Add unit rotation for ranged units
- Future: Multi-select for batch placement
- Coordinate with Task 003 on UnitManager changes
- Use Unity's EventSystem for clean input handling
