# Task 007: Round Management & Difficulty Scaling

## Metadata
```yaml
---
epic: lotto-defense
task_id: "007"
title: "Round Management & Difficulty Scaling"
status: todo
priority: high
estimated_hours: 16
depends_on: ["006"]
parallel: false
created: 2025-10-28T02:12:15Z
updated: 2025-10-28T02:12:15Z
assignee: unity-game-developer
---
```

## Overview
Implement round-based gameplay loop with preparation/combat phases, difficulty progression through ScriptableObject configs, and win/loss conditions with appropriate UI screens.

## Requirements

### Functional Requirements
- **Phase Management**: Preparation timer (30s) → Combat timer (60s) with UI countdown displays
- **Round Completion Logic**: Calculate success (all monsters defeated) or life loss based on remaining enemies
- **Difficulty Scaling**: DifficultyConfig ScriptableObject with HP/Defense multipliers per round (1-30)
- **Victory Condition**: Display victory screen when round 30 is completed
- **Defeat Condition**: Display defeat screen when player life reaches 0
- **Scene Flow**: Transition back to MainGame scene on game over/restart

### Technical Requirements
- **Namespace**: LottoDefense.Gameplay
- **Dependencies**: Combat system (Task 006), Monster spawning system
- **Performance**: Maintain 60 FPS during phase transitions

## Implementation Plan

### Files to Create
```
Assets/Scripts/Gameplay/RoundManager.cs
Assets/Scripts/Gameplay/DifficultyConfig.cs
Assets/Scripts/UI/VictoryScreen.cs
Assets/Scripts/UI/DefeatScreen.cs
Assets/Data/DifficultyConfig.asset
```

### Core Components

#### 1. RoundManager.cs
```csharp
namespace LottoDefense.Gameplay
{
    public class RoundManager : MonoBehaviour
    {
        // Phase management
        public enum GamePhase { Preparation, Combat }
        private GamePhase currentPhase;
        private float phaseTimer;

        // Round state
        private int currentRound = 1;
        private const int MAX_ROUNDS = 30;

        // Configuration
        [SerializeField] private DifficultyConfig difficultyConfig;
        [SerializeField] private float preparationDuration = 30f;
        [SerializeField] private float combatDuration = 60f;

        // References
        private MonsterSpawner monsterSpawner;
        private PlayerStats playerStats;

        // Events
        public event Action<GamePhase> OnPhaseChanged;
        public event Action<int> OnRoundChanged;
        public event Action<float> OnTimerUpdated;

        public void StartPreparationPhase();
        public void StartCombatPhase();
        public void EndCombatPhase();
        public void CheckRoundCompletion();
        public DifficultyMultipliers GetCurrentDifficultyMultipliers();
    }
}
```

#### 2. DifficultyConfig.cs
```csharp
namespace LottoDefense.Gameplay
{
    [System.Serializable]
    public struct DifficultyMultipliers
    {
        public float hpMultiplier;
        public float defenseMultiplier;
    }

    [CreateAssetMenu(fileName = "DifficultyConfig", menuName = "LottoDefense/Difficulty Config")]
    public class DifficultyConfig : ScriptableObject
    {
        [Header("Difficulty Curve (Rounds 1-30)")]
        [SerializeField] private AnimationCurve hpCurve;
        [SerializeField] private AnimationCurve defenseCurve;

        [Header("Base Multipliers")]
        [SerializeField] private float baseHpMultiplier = 1.0f;
        [SerializeField] private float baseDefenseMultiplier = 1.0f;

        public DifficultyMultipliers GetMultipliersForRound(int round)
        {
            float normalizedRound = Mathf.Clamp01((round - 1) / 29f);
            return new DifficultyMultipliers
            {
                hpMultiplier = baseHpMultiplier * hpCurve.Evaluate(normalizedRound),
                defenseMultiplier = baseDefenseMultiplier * defenseCurve.Evaluate(normalizedRound)
            };
        }
    }
}
```

#### 3. VictoryScreen.cs
```csharp
namespace LottoDefense.UI
{
    public class VictoryScreen : MonoBehaviour
    {
        [SerializeField] private GameObject victoryPanel;
        [SerializeField] private TextMeshProUGUI finalRoundText;
        [SerializeField] private TextMeshProUGUI totalGoldText;
        [SerializeField] private Button returnToMenuButton;

        public void ShowVictory(int finalRound, int totalGold);
        private void ReturnToMainMenu();
    }
}
```

#### 4. DefeatScreen.cs
```csharp
namespace LottoDefense.UI
{
    public class DefeatScreen : MonoBehaviour
    {
        [SerializeField] private GameObject defeatPanel;
        [SerializeField] private TextMeshProUGUI survivedRoundsText;
        [SerializeField] private Button restartButton;
        [SerializeField] private Button returnToMenuButton;

        public void ShowDefeat(int survivedRounds);
        private void RestartGame();
        private void ReturnToMainMenu();
    }
}
```

### Implementation Steps

1. **Create DifficultyConfig ScriptableObject**
   - Define HP curve (1.0x → 5.0x over 30 rounds)
   - Define Defense curve (1.0x → 3.0x over 30 rounds)
   - Create asset at Assets/Data/DifficultyConfig.asset

2. **Implement RoundManager**
   - Phase state machine (Preparation ↔ Combat)
   - Timer countdown logic with events
   - Round progression logic
   - Victory/defeat condition checks
   - Integration with MonsterSpawner for difficulty application

3. **Create Victory/Defeat UI**
   - Victory screen with stats display
   - Defeat screen with restart/menu options
   - Scene transition logic using SceneManager

4. **UI Integration**
   - Phase indicator UI (Preparation/Combat label)
   - Countdown timer display (MM:SS format)
   - Current round display (Round X/30)

5. **Testing**
   - Phase transitions trigger correctly
   - Timers display accurately
   - Difficulty multipliers apply to monsters
   - Victory triggers at round 30 completion
   - Defeat triggers at life 0
   - Scene transitions work properly

## Acceptance Criteria
- [ ] Preparation phase lasts 30s, combat phase lasts 60s
- [ ] UI countdown displays remaining time in MM:SS format
- [ ] Round advances automatically after combat phase
- [ ] Difficulty multipliers scale from 1.0x to 5.0x (HP) and 3.0x (Defense) over 30 rounds
- [ ] Victory screen displays on round 30 completion
- [ ] Defeat screen displays when player life reaches 0
- [ ] Scene transition returns to MainGame scene on restart/menu
- [ ] All phase transitions maintain 60 FPS

## Testing Strategy

### Unit Tests
```csharp
[Test]
public void DifficultyConfig_Round1_ReturnsBaseMultipliers();
[Test]
public void DifficultyConfig_Round30_ReturnsMaxMultipliers();
[Test]
public void RoundManager_PreparationPhase_LastsExactly30Seconds();
[Test]
public void RoundManager_CombatPhase_LastsExactly60Seconds();
[Test]
public void RoundManager_AllMonstersDefeated_AdvancesRound();
[Test]
public void RoundManager_Round30Complete_TriggersVictory();
[Test]
public void RoundManager_Life0_TriggersDefeat();
```

### Integration Tests
- Test full round cycle: Preparation → Combat → Round completion
- Test difficulty scaling over multiple rounds
- Test victory condition flow
- Test defeat condition flow

### Manual Testing
- Verify timer displays correctly
- Verify smooth phase transitions
- Verify difficulty increases are noticeable
- Verify victory/defeat screens display properly
- Verify scene transitions work

## Dependencies
- Task 006: Combat System (required for round completion logic)
- MonsterSpawner system (apply difficulty multipliers)
- PlayerStats system (track life)
- SceneManager (scene transitions)

## Notes
- This task blocks Task 010 (Polish & Balance) as it provides the core game loop
- Difficulty curve should be tunable via AnimationCurve for easy balance adjustments
- Consider adding pause functionality during combat phase
- Timer should pause when game is paused (if pause system exists)

## Conflicts
- None (sequential task after combat system)

## Risk Assessment
- **Medium Risk**: Timer synchronization with game events could have edge cases
- **Mitigation**: Thorough testing of phase transitions and round completion logic
