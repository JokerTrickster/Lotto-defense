---
name: Game State Machine & Countdown Animation
status: open
created: 2025-10-28T02:12:15Z
updated: 2025-10-28T02:12:15Z
github:
depends_on: []
parallel: false
conflicts_with: []
---

## Description

Implement the core game state machine that manages the flow of gameplay phases, starting with a countdown animation system. The GameplayManager will orchestrate transitions between Countdown, Preparation, Combat, RoundResult, Victory, and Defeat states. Initial game values are set to Round 1, Life 10, and Gold 50.

## Acceptance Criteria

- [ ] GameState enum defines all game phases (Countdown, Preparation, Combat, RoundResult, Victory, Defeat)
- [ ] GameplayManager implements singleton pattern for global access
- [ ] Countdown animation displays "3-2-1" with 1-second intervals
- [ ] Visual feedback includes scaling animation and sound effects for each countdown number
- [ ] Automatic state transition from Countdown to Preparation after "1"
- [ ] Game state initialization sets Round=1, Life=10, Gold=50
- [ ] State change events fire to notify other systems
- [ ] Current game state is queryable by other systems

## Technical Details

### Namespace
- `LottoDefense.Gameplay` for GameplayManager and GameState

### Files to Create/Modify
1. **Assets/Scripts/Gameplay/GameState.cs**
   ```csharp
   namespace LottoDefense.Gameplay
   {
       public enum GameState
       {
           Countdown,
           Preparation,
           Combat,
           RoundResult,
           Victory,
           Defeat
       }
   }
   ```

2. **Assets/Scripts/Gameplay/GameplayManager.cs**
   - Singleton instance
   - Properties: CurrentState, CurrentRound, CurrentLife, CurrentGold
   - Methods:
     - `Initialize()` - Set initial values
     - `ChangeState(GameState newState)` - State transitions with validation
     - `StartCountdown()` - Trigger countdown animation
   - Events:
     - `OnStateChanged(GameState oldState, GameState newState)`
     - `OnGameValueChanged(string valueType, int newValue)`

3. **Assets/Scripts/Gameplay/CountdownUI.cs**
   - Display countdown numbers with animation
   - Scale tween: 0.5 → 1.5 → 1.0 over 0.8 seconds
   - Audio: Play countdown beep on each number
   - Auto-destroy after completion

4. **GameScene.unity**
   - Create empty GameObject "GameplayManager" with GameplayManager component
   - Create Canvas/CountdownUI hierarchy
   - Configure TextMeshProUGUI for countdown display

### State Transition Rules
- **Countdown → Preparation**: Automatic after 3 seconds
- **Preparation → Combat**: Manual trigger when player confirms
- **Combat → RoundResult**: When all monsters defeated or life reaches 0
- **RoundResult → Preparation**: Auto after result display (next round)
- **RoundResult → Victory**: When target round completed
- **Any → Defeat**: When life reaches 0

### Initial Values
```csharp
private const int INITIAL_ROUND = 1;
private const int INITIAL_LIFE = 10;
private const int INITIAL_GOLD = 50;
```

## Dependencies

### External Dependencies
- TextMeshPro for countdown UI text
- DOTween (optional) for animation tweening, or Unity's Animation system

### Internal Dependencies
- None (this is the foundation task)

## Effort Estimate

**Total: 1 day (8 hours)**

Breakdown:
- GameState enum and GameplayManager structure: 1 hour
- State machine logic and transitions: 2 hours
- Countdown animation system: 2 hours
- UI setup and integration: 2 hours
- Testing and polish: 1 hour

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Code follows Unity C# naming conventions (PascalCase for public, camelCase for private)
- [ ] GameplayManager accessible via `GameplayManager.Instance`
- [ ] Countdown animation plays smoothly at game start
- [ ] State transitions log to console for debugging
- [ ] No errors in Unity console
- [ ] Game initializes with correct values (Round 1, Life 10, Gold 50)
- [ ] Manual testing confirms countdown → preparation flow works
- [ ] Code reviewed for singleton thread safety
- [ ] XML documentation comments added for public APIs
